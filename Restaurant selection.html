<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐廳隨機選擇器</title>
    <!-- 引入Leaflet.js庫，用於顯示OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- 引入Papa Parse用於CSV解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #4ecdc4;
            --accent-color: #ffd166;
            --dark-color: #2b2d42;
            --light-color: #f7f7f7;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .filter-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .result-section {
            flex: 2;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        select, input[type="number"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #e05a5a;
        }
        
        .data-source-toggle {
            display: flex;
            margin-bottom: 15px;
        }
        
        .data-source-toggle button {
            flex: 1;
            background-color: #ddd;
            color: var(--dark-color);
        }
        
        .data-source-toggle button.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .random-result {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background-color: var(--accent-color);
            border-radius: 10px;
            display: none;
        }
        
        .restaurant-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .restaurant-info {
            margin-bottom: 15px;
        }
        
        #map {
            height: 300px;
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .csv-container {
            display: block;
        }
        
        .animation {
            text-align: center;
            font-size: 48px;
            margin: 40px 0;
            color: var(--primary-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .hidden {
            display: none;
        }

        .search-results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .search-result-item:hover {
            background-color: #f5f5f5;
        }

        .restaurant-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .restaurant-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .restaurant-item-info {
            flex: 1;
        }

        .restaurant-item-name {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>餐廳隨機選擇器</h1>
            <p>告別選擇困難症，讓我們為您決定今天吃什麼！</p>
        </header>
        
        <div class="main-content">
            <div class="filter-section">
                <div class="data-source-toggle">
                    <button id="location-toggle" class="active">使用我的位置</button>
                    <button id="csv-toggle">上傳CSV檔案</button>
                </div>
                
                <div id="location-container" class="location-container">
                    <div class="filter-group">
                        <div class="filter-title">篩選餐廳類型</div>
                        <select id="cuisine-type">
                            <option value="">所有類型</option>
                            <option value="chinese">中餐</option>
                            <option value="japanese">日本料理</option>
                            <option value="korean">韓國料理</option>
                            <option value="american">美式料理</option>
                            <option value="italian">義式料理</option>
                            <option value="thai">泰式料理</option>
                            <option value="vietnamese">越南料理</option>
                            <option value="mexican">墨西哥菜</option>
                            <option value="indian">印度菜</option>
                            <option value="french">法國菜</option>
                            <option value="seafood">海鮮</option>
                            <option value="dessert">甜點</option>
                            <option value="cafe">咖啡廳</option>
                            <option value="fastfood">速食</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-title">篩選價格</div>
                        <select id="price-range">
                            <option value="">所有價格</option>
                            <option value="1">$ (便宜)</option>
                            <option value="2">$$ (適中)</option>
                            <option value="3">$$$ (昂貴)</option>
                            <option value="4">$$$$ (非常昂貴)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-title">篩選地區範圍 (公里)</div>
                        <select id="radius-select">
                            <option value="0.5">0.5 公里</option>
                            <option value="1">1 公里</option>
                            <option value="2">2 公里</option>
                            <option value="5" selected>5 公里</option>
                        </select>
                    </div>
                </div>
                
                <div id="csv-container" class="csv-container" style="display: none;">
                    <div class="filter-group">
                        <div class="filter-title">上傳CSV檔案</div>
                        <input type="file" id="csv-file" accept=".csv">
                        <p class="hint">CSV格式應包含: 名稱,類別,價格,地址,電話,評分</p>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-title">從CSV篩選類別</div>
                        <select id="csv-cuisine-type" disabled>
                            <option value="">所有類別</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-title">從CSV篩選價格範圍</div>
                        <select id="csv-price-range" disabled>
                            <option value="">所有價格</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-title">篩選地區範圍 (公里)</div>
                        <select id="csv-radius-select">
                            <option value="0.5">0.5 公里</option>
                            <option value="1">1 公里</option>
                            <option value="2">2 公里</option>
                            <option value="5" selected>5 公里</option>
                        </select>
                    </div>
                </div>
                
                <button id="random-button">隨機選擇餐廳！</button>
                
                <div class="filter-group">
                    <div class="filter-title">搜尋餐廳</div>
                    <input type="text" id="search-input" placeholder="輸入餐廳名稱或類別">
                    <div id="search-results" class="search-results hidden"></div>
                </div>
                
                <div id="restaurant-list" class="restaurant-list hidden">
                    <div class="filter-title">已導入餐廳列表</div>
                </div>
            </div>
            
            <div class="result-section">
                <h2>您的隨機餐廳</h2>
                
                <div id="loading" class="animation hidden">
                    <div class="spinner"></div>
                    <div>正在為您選擇中...</div>
                </div>
                
                <div id="random-result" class="random-result">
                    <div class="restaurant-name" id="restaurant-name"></div>
                    <div class="restaurant-info" id="restaurant-info"></div>
                    <div class="restaurant-info" id="restaurant-address"></div>
                    <div class="restaurant-info" id="restaurant-phone"></div>
                    <div class="restaurant-info" id="restaurant-rating"></div>
                    <button id="directions-button">查看路線</button>
                </div>
                
                <div id="map"></div>
                
                <button id="retry-button" style="margin-top: 20px; display: none;">重新選擇</button>
            </div>
        </div>
    </div>

    <script>
        // 全局變數
        let restaurantData = [];
        let map = null;
        let marker = null;
        let csvData = [];
        let csvCategories = new Set();
        let csvPriceRanges = new Set();
        let userLocation = null;
        let dataSource = 'location'; // 新增變數，表示資料來源 ('location' 或 'csv')
        let nearbyRestaurants = []; // 存儲附近餐廳的數組
        
        // DOM 元素
        const locationToggle = document.getElementById('location-toggle');
        const csvToggle = document.getElementById('csv-toggle');
        const locationContainer = document.getElementById('location-container');
        const csvContainer = document.getElementById('csv-container');
        const randomButton = document.getElementById('random-button');
        const retryButton = document.getElementById('retry-button');
        const randomResult = document.getElementById('random-result');
        const restaurantName = document.getElementById('restaurant-name');
        const restaurantInfo = document.getElementById('restaurant-info');
        const restaurantAddress = document.getElementById('restaurant-address');
        const restaurantPhone = document.getElementById('restaurant-phone');
        const restaurantRating = document.getElementById('restaurant-rating');
        const directionsButton = document.getElementById('directions-button');
        const loadingElement = document.getElementById('loading');
        const csvFileInput = document.getElementById('csv-file');
        const csvCuisineSelect = document.getElementById('csv-cuisine-type');
        const csvPriceSelect = document.getElementById('csv-price-range');
        const cuisineSelect = document.getElementById('cuisine-type');
        const priceRangeSelect = document.getElementById('price-range');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const restaurantListElement = document.getElementById('restaurant-list');

        // 切換數據源的事件監聽
        locationToggle.addEventListener('click', () => {
            dataSource = 'location';
            locationToggle.classList.add('active');
            csvToggle.classList.remove('active');
            locationContainer.style.display = 'block';
            csvContainer.style.display = 'none';
        });
        
        csvToggle.addEventListener('click', () => {
            dataSource = 'csv';
            csvToggle.classList.add('active');
            locationToggle.classList.remove('active');
            csvContainer.style.display = 'block';
            locationContainer.style.display = 'none';
        });

        // 獲取使用者的地理位置
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        console.log("使用者位置：", userLocation);
                    },
                    (error) => {
                        console.error("無法獲取使用者位置：", error);
                        alert("無法獲取您的位置，將使用默認位置（香港將軍澳）。");
                        
                        // 設置默認位置為香港將軍澳 (22.3185, 114.2716)
                        userLocation = {
                            lat: 22.3185,
                            lng: 114.2716
                        };
                    }
                );
            } else {
                alert("您的瀏覽器不支援地理定位功能，將使用默認位置（香港將軍澳）。");
                
                // 設置默認位置為香港將軍澳
                userLocation = {
                    lat: 22.3185,
                    lng: 114.2716
                };
            }
        }

        // 計算兩點之間的距離（單位：公里）
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // 地球半徑（公里）
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLng = ((lng2 - lng1) * Math.PI) / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos((lat1 * Math.PI) / 180) *
                    Math.cos((lat2 * Math.PI) / 180) *
                    Math.sin(dLng / 2) *
                    Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        // 使用Nominatim API進行地理編碼 (將地址轉換為經緯度)
        async function geocodeAddress(address) {
            try {
                const encodedAddress = encodeURIComponent(address);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('地理編碼錯誤:', error);
                return null;
            }
        }

        // 使用Overpass API查詢附近的餐廳
        async function fetchNearbyRestaurantsFromAPI() {
            if (!userLocation) {
                return [];
            }

            loadingElement.classList.remove('hidden');
            
            try {
                const radius = parseFloat(document.getElementById("radius-select").value) * 1000; // 公里轉換為米
                const cuisineType = cuisineSelect.value;
                const priceRange = priceRangeSelect.value;
                
                // 構建Overpass查詢
                let query = `
                    [out:json];
                    (
                        node["amenity"="restaurant"](around:${radius},${userLocation.lat},${userLocation.lng});
                        node["amenity"="cafe"](around:${radius},${userLocation.lat},${userLocation.lng});
                        node["amenity"="fast_food"](around:${radius},${userLocation.lat},${userLocation.lng});
                        way["amenity"="restaurant"](around:${radius},${userLocation.lat},${userLocation.lng});
                        way["amenity"="cafe"](around:${radius},${userLocation.lat},${userLocation.lng});
                        way["amenity"="fast_food"](around:${radius},${userLocation.lat},${userLocation.lng});
                    );
                    out body;
                    >;
                    out skel qt;
                `;

                // 發送查詢
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: `data=${encodeURIComponent(query)}`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const restaurants = [];

                // 處理結果
                if (data && data.elements) {
                    for (const element of data.elements) {
                        // 只處理節點類型的元素（餐廳點）
                        if (element.type === 'node' && element.tags) {
                            const restaurant = {
                                id: element.id,
                                name: element.tags.name || '未命名餐廳',
                                categories: [],
                                price: element.tags['price_range'] || '',
                                address: element.tags['addr:full'] || element.tags['addr:housenumber'] ? 
                                    (element.tags['addr:housenumber'] || '') + ' ' + (element.tags['addr:street'] || '') : '',
                                phone: element.tags.phone || '',
                                website: element.tags.website || '',
                                opening_hours: element.tags.opening_hours || '',
                                rating: '',
                                lat: element.lat,
                                lng: element.lon
                            };

                            // 解析餐廳類別
                            if (element.tags.cuisine) {
                                restaurant.categories = element.tags.cuisine.split(';').map(c => c.trim());
                            } else if (element.tags.amenity === 'restaurant') {
                                restaurant.categories.push('restaurant');
                            } else if (element.tags.amenity === 'cafe') {
                                restaurant.categories.push('cafe');
                            } else if (element.tags.amenity === 'fast_food') {
                                restaurant.categories.push('fast_food');
                            }

                            // 按類型過濾
                            if (cuisineType && restaurant.categories.length > 0) {
                                if (!restaurant.categories.some(cat => 
                                    cat.toLowerCase().includes(cuisineType.toLowerCase())
                                )) {
                                    continue;
                                }
                            }

                            // 按價格範圍過濾
                            if (priceRange && restaurant.price && restaurant.price !== priceRange) {
                                continue;
                            }

                            restaurants.push(restaurant);
                        }
                    }
                }

                if (restaurants.length === 0) {
                    // 如果Overpass API沒有返回結果，嘗試使用Google Places API的樣本數據
                    // 這裡只是模擬數據，實際使用時應該接入Google Places API
                    const mockRestaurants = [
                        {
                            id: 'mock1',
                            name: '將軍澳中心餐廳',
                            categories: ['中餐', '粵菜'],
                            price: '2',
                            address: '將軍澳唐德街9號將軍澳中心',
                            phone: '2345-6789',
                            rating: '4.2',
                            lat: 22.3077,
                            lng: 114.2627
                        },
                        {
                            id: 'mock2',
                            name: '寶琳日式料理',
                            categories: ['日本料理', 'sushi'],
                            price: '3',
                            address: '將軍澳寶琳北路100號',
                            phone: '3456-7890',
                            rating: '4.5',
                            lat: 22.3228,
                            lng: 114.2571
                        },
                        {
                            id: 'mock3',
                            name: '坑口韓國烤肉',
                            categories: ['韓國料理', 'bbq'],
                            price: '3',
                            address: '將軍澳坑口道10號',
                            phone: '2567-8901',
                            rating: '4.0',
                            lat: 22.3160,
                            lng: 114.2694
                        },
                        {
                            id: 'mock4',
                            name: '康城海鮮酒家',
                            categories: ['seafood', '粵菜'],
                            price: '4',
                            address: '將軍澳康城路1號',
                            phone: '3678-9012',
                            rating: '4.7',
                            lat: 22.2963,
                            lng: 114.2699
                        },
                        {
                            id: 'mock5',
                            name: '將軍澳廣場咖啡店',
                            categories: ['cafe', 'dessert'],
                            price: '2',
                            address: '將軍澳重華路8號將軍澳廣場',
                            phone: '2789-0123',
                            rating: '3.9',
                            lat: 22.3168,
                            lng: 114.2651
                        },
                        {
                            id: 'mock6',
                            name: 'PopCorn義大利餐廳',
                            categories: ['italian'],
                            price: '3',
                            address: '將軍澳唐賢街9號PopCorn商場',
                            phone: '3890-1234',
                            rating: '4.3',
                            lat: 22.3079,
                            lng: 114.2642
                        }
                    ];

                    // 應用過濾條件到模擬數據
                    const filteredMock = mockRestaurants.filter(restaurant => {
                        // 按類型過濾
                        if (cuisineType) {
                            let matchesCuisine = false;
                            for (const category of restaurant.categories) {
                                if (category.toLowerCase().includes(cuisineType.toLowerCase())) {
                                    matchesCuisine = true;
                                    break;
                                }
                            }
                            if (!matchesCuisine) return false;
                        }

                        // 按價格範圍過濾
                        if (priceRange && restaurant.price !== priceRange) {
                            return false;
                        }

                        // 按距離過濾
                        const distance = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            restaurant.lat,
                            restaurant.lng
                        );
                        return distance <= parseFloat(document.getElementById("radius-select").value);
                    });

                    return filteredMock;
                }

                return restaurants;
            } catch (error) {
                console.error("獲取附近餐廳時出錯：", error);
                return [];
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        // 解析CSV文件
        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        // 更新地圖邏輯
        function updateMap(restaurant) {
            if (!map) {
                map = L.map('map').setView([restaurant.lat, restaurant.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView([restaurant.lat, restaurant.lng], 15);
            }

            // 清除舊的標記
            if (marker) {
                map.removeLayer(marker);
            }

            // 添加新的標記
            marker = L.marker([restaurant.lat, restaurant.lng]).addTo(map);
            marker.bindPopup(`<b>${restaurant.name}</b><br>${restaurant.address}`).openPopup();

            // 顯示地圖
            document.getElementById('map').style.display = 'block';
            
            // 重新調整地圖大小以確保正確顯示
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        // 處理餐廳數據
        async function processCSVData(data) {
            csvCategories.clear();
            csvPriceRanges.clear();
            
            const processedData = [];
            
            for (const row of data) {
                // 標準化數據的鍵名
                const restaurantData = {
                    name: row['名稱'] || row['name'] || '',
                    categories: row['類別'] ? row['類別'].split(',').map(c => c.trim()) : (row['categories'] ? row['categories'].split(',').map(c => c.trim()) : []),
                    price: row['價格'] || row['price'] || '',
                    address: row['地址'] || row['address'] || '',
                    phone: row['電話'] || row['phone'] || '',
                    rating: row['評分'] || row['rating'] || '',
                    lat: parseFloat(row['緯度'] || row['lat'] || 0),
                    lng: parseFloat(row['經度'] || row['lng'] || 0)
                };
                
                // 如果沒有經緯度，嘗試地理編碼
                if ((!restaurantData.lat || !restaurantData.lng) && restaurantData.address) {
                    try {
                        const coords = await geocodeAddress(restaurantData.address);
                        if (coords) {
                            restaurantData.lat = coords.lat;
                            restaurantData.lng = coords.lng;
                        }
                    } catch (error) {
                        console.error('地理編碼錯誤:', error);
                    }
                }
                
                // 收集類別和價格範圍，以便稍後填充下拉選單
                if (restaurantData.categories && restaurantData.categories.length) {
                    restaurantData.categories.forEach(cat => {
                        if (cat) csvCategories.add(cat);
                    });
                }
                
                if (restaurantData.price) {
                    csvPriceRanges.add(restaurantData.price);
                }
                
                processedData.push(restaurantData);
            }
            
            return processedData;
        }
        
        // 更新類別和價格範圍下拉選單
        function updateSelects() {
            // 清空現有選項
            while (csvCuisineSelect.options.length > 1) {
                csvCuisineSelect.remove(1);
            }
            
            while (csvPriceSelect.options.length > 1) {
                csvPriceSelect.remove(1);
            }
            
            // 添加新的類別選項
            [...csvCategories].sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                csvCuisineSelect.appendChild(option);
            });
            
            // 添加新的價格範圍選項
            [...csvPriceRanges].sort().forEach(price => {
                const option = document.createElement('option');
                option.value = price;
                option.textContent = price;
                csvPriceSelect.appendChild(option);
            });
            
            // 啟用選擇框
            csvCuisineSelect.disabled = false;
            csvPriceSelect.disabled = false;
        }
        
        // 更新餐廳列表
        function updateRestaurantList() {
            restaurantListElement.innerHTML = '<div class="filter-title">已導入餐廳列表</div>';
            
            const restaurants = dataSource === 'csv' ? csvData : nearbyRestaurants;
            
            if (restaurants.length > 0) {
                restaurants.forEach((restaurant, index) => {
                    const item = document.createElement('div');
                    item.className = 'restaurant-item';
                    item.innerHTML = `
                        <div class="restaurant-item-info">
                            <div class="restaurant-item-name">${restaurant.name}</div>
                            <div>${restaurant.categories.join(', ')} | ${restaurant.price || '未指定價格'}</div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        displayRestaurantResult(restaurant);
                        updateMap(restaurant);
                        randomResult.style.display = 'block';
                        retryButton.style.display = 'block';
                    });
                    
                    restaurantListElement.appendChild(item);
                });
                
                restaurantListElement.classList.remove('hidden');
            } else {
                restaurantListElement.classList.add('hidden');
            }
        }
        
        // 隨機選擇餐廳
        async function selectRandomRestaurant() {
            loadingElement.classList.remove('hidden');
            randomResult.style.display = 'none';
            retryButton.style.display = 'none';
            
            let filteredRestaurants = [];
            
            if (dataSource === 'csv') {
                // 確認是否有CSV資料
                if (csvData.length === 0) {
                    loadingElement.classList.add('hidden');
                    alert('請先上傳CSV檔案！');
                    return;
                }
                
                // 根據篩選條件過濾餐廳
                const selectedCategory = csvCuisineSelect.value;
                const selectedPrice = csvPriceSelect.value;
                const radius = parseFloat(document.getElementById("csv-radius-select").value);
                
                filteredRestaurants = csvData;
                
                // 篩選類別
                if (selectedCategory) {
                    filteredRestaurants = filteredRestaurants.filter(restaurant => 
                        restaurant.categories.includes(selectedCategory)
                    );
                }
                
                // 篩選價格
                if (selectedPrice) {
                    filteredRestaurants = filteredRestaurants.filter(restaurant => 
                        restaurant.price === selectedPrice
                    );
                }
                
                // 篩選距離
                if (userLocation) {
                    filteredRestaurants = filteredRestaurants.filter(restaurant => {
                        if (!restaurant.lat || !restaurant.lng) return false;
                        
                        const distance = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            restaurant.lat,
                            restaurant.lng
                        );
                        return distance <= radius;
                    });
                }
            } else {
                // 使用位置 API 獲取附近餐廳
                nearbyRestaurants = await fetchNearbyRestaurantsFromAPI();
                filteredRestaurants = nearbyRestaurants;
                
                // 更新餐廳列表
                updateRestaurantList();
            }

            setTimeout(() => {
                loadingElement.classList.add('hidden');

                if (filteredRestaurants.length === 0) {
                    alert('沒有找到符合條件的餐廳，請嘗試調整篩選條件。');
                    return;
                }

                const randomIndex = Math.floor(Math.random() * filteredRestaurants.length);
                const selectedRestaurant = filteredRestaurants[randomIndex];

                displayRestaurantResult(selectedRestaurant);
                updateMap(selectedRestaurant);
                retryButton.style.display = 'block';
            }, 1500);
        }

        // 顯示餐廳結果
        function displayRestaurantResult(restaurant) {
            restaurantName.textContent = restaurant.name || '未知餐廳';

            const categoriesText = restaurant.categories && restaurant.categories.length ? 
                restaurant.categories.join(', ') : '未分類';
                
            let priceText = '';
            if (restaurant.price) {
                // 處理數字類型的價格
                if (restaurant.price >= 1 && restaurant.price <= 4) {
                    priceText = '價格: ' + '$'.repeat(parseInt(restaurant.price));
                } else {
                    priceText = '價格: ' + restaurant.price;
                }
            } else {
                priceText = '價格: 未提供';
            }
                
            restaurantInfo.innerHTML = `類型: ${categoriesText} | ${priceText}`;
            restaurantAddress.textContent = `地址: ${restaurant.address || '未提供'}`;
            restaurantPhone.textContent = `電話: ${restaurant.phone || '未提供'}`;
            restaurantRating.textContent = `評分: ${restaurant.rating || '未提供'}`;

            // 如果有位置信息，計算距離
            if (userLocation && restaurant.lat && restaurant.lng) {
                const distance = calculateDistance(
                    userLocation.lat,
                    userLocation.lng,
                    restaurant.lat,
                    restaurant.lng
                ).toFixed(2);
                
                const distanceElement = document.createElement('p');
                distanceElement.textContent = `距離: ${distance} 公里`;
                restaurantInfo.appendChild(distanceElement);
            }

            randomResult.style.display = 'block';
            
            // 設置導航按鈕事件
            directionsButton.onclick = () => {
                if (restaurant.lat && restaurant.lng) {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${restaurant.lat},${restaurant.lng}`, '_blank');
                } else {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(restaurant.address || restaurant.name)}`, '_blank');
                }
            };
        }

        // 搜尋餐廳
        function searchRestaurants(keyword) {
            if (!keyword) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const lowerKeyword = keyword.toLowerCase();
            const restaurants = dataSource === 'csv' ? csvData : nearbyRestaurants;
            
            const results = restaurants.filter((restaurant) => {
                return (
                    (restaurant.name && restaurant.name.toLowerCase().includes(lowerKeyword)) ||
                    (restaurant.categories && restaurant.categories.some((category) => 
                        category.toLowerCase().includes(lowerKeyword)
                    )) ||
                    (restaurant.address && restaurant.address.toLowerCase().includes(lowerKeyword))
                );
            });
            
            displaySearchResults(results);
        }
        
        // 顯示搜尋結果
        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">沒有找到符合的餐廳</div>';
            } else {
                results.forEach(restaurant => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.textContent = `${restaurant.name} (${restaurant.categories.join(', ')})`;
                    
                    resultItem.addEventListener('click', () => {
                        displayRestaurantResult(restaurant);
                        updateMap(restaurant);
                        randomResult.style.display = 'block';
                        retryButton.style.display = 'block';
                        searchResults.classList.add('hidden');
                        searchInput.value = '';
                    });
                    
                    searchResults.appendChild(resultItem);
                });
            }
            
            searchResults.classList.remove('hidden');
        }

        // 監聽CSV檔案上傳
        csvFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                try {
                    const data = await parseCSVFile(file);
                    csvData = await processCSVData(data);
                    
                    updateSelects();
                    updateRestaurantList();
                    
                    alert(`成功導入 ${csvData.length} 家餐廳！`);
                } catch (error) {
                    console.error('解析CSV檔案錯誤:', error);
                    alert('CSV檔案解析失敗！請確認格式是否正確。');
                }
            }
        });

        // 監聽搜尋輸入
        searchInput.addEventListener('input', (event) => {
            const keyword = event.target.value.trim();
            searchRestaurants(keyword);
        });

        // 監聽按鈕點擊
        randomButton.addEventListener('click', selectRandomRestaurant);
        retryButton.addEventListener('click', selectRandomRestaurant);

        // 初始化頁面
        document.addEventListener('DOMContentLoaded', () => {
            getUserLocation(); // 獲取使用者位置
        });
    </script>
</body>
</html>
